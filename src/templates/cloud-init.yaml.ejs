#cloud-config
hostname: nexus-vm
users:
  - name: nexus
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    ssh_authorized_keys:
      - <%= sshPubKey %>

runcmd:
  # Wait for network + install packages (QEMU SLIRP DNS is slow at boot)
  - |
    PACKAGES="docker.io docker-compose software-properties-common git curl wget jq tmux auditd ufw libvirt-daemon libvirt-daemon-system libvirt-clients"
    for attempt in $(seq 1 10); do
      apt-get update && \
      DEBIAN_FRONTEND=noninteractive apt-get install -y --fix-missing $PACKAGES && \
      break
      echo "Package install failed (attempt $attempt/10), retrying in 15s..."
      sleep 15
    done

  # Fix ownership on deferred write_files (user now exists)
  - chown -R nexus:nexus /home/nexus/.nexus

  # Security hardening
  - ufw default deny incoming
  - ufw default deny outgoing
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 4200/tcp
  - ufw allow out 53
  - ufw allow out 80/tcp
  - ufw allow out 443/tcp
  - ufw --force enable
  - systemctl enable auditd
  - systemctl start auditd

  # SSH hardening
  - sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  - systemctl restart ssh

  # Docker setup
  - usermod -aG docker nexus
  - systemctl start docker
  - systemctl enable docker

  # Harden Docker daemon
  - |
    cat > /etc/docker/daemon.json << 'DAEMON'
    {
      "no-new-privileges": true,
      "log-driver": "json-file",
      "log-opts": { "max-size": "10m", "max-file": "3" },
      "live-restore": true,
      "userland-proxy": false
    }
    DAEMON
  - systemctl restart docker

  # KVM/libvirt for triple nesting (mandatory)
  - systemctl start libvirtd
  - systemctl enable libvirtd
  - usermod -aG libvirt nexus

  # Python 3.12 (Jammy ships 3.10; NEXUS requires >= 3.11 for datetime.UTC)
  - add-apt-repository -y ppa:deadsnakes/ppa
  - apt-get update -qq
  - DEBIAN_FRONTEND=noninteractive apt-get install -y -qq python3.12 python3.12-venv python3.12-dev

  # Extract NEXUS from release tarball (uploaded via SCP after SSH is ready)
  - sudo -u nexus mkdir -p /home/nexus/nexus
  - |
    # Wait for tarball upload (max 5 minutes)
    for i in $(seq 1 60); do
      [ -f /tmp/nexus-release.tar.gz ] && break
      sleep 5
    done
  - sudo -u nexus tar xzf /tmp/nexus-release.tar.gz -C /home/nexus/nexus
  - rm -f /tmp/nexus-release.tar.gz

  # Python environment (must use python3.12 for datetime.UTC support)
  - sudo -u nexus python3.12 -m venv /home/nexus/nexus/.venv
  - sudo -u nexus /home/nexus/nexus/.venv/bin/pip install --upgrade pip
  - sudo -u nexus /home/nexus/nexus/.venv/bin/pip install -r /home/nexus/nexus/requirements.txt

  # Build Docker sandbox image
  - docker build -t nexus-cli-sandbox /home/nexus/nexus/docker/cli-sandbox/

  # Generate database salt
  - sudo -u nexus mkdir -p /home/nexus/.nexus
  - sudo -u nexus python3 -c "import os; open('/home/nexus/.nexus/.db_salt','wb').write(os.urandom(16))"

  # Nesting enforcement — NEXUS refuses to start outside nested environment
  - |
    cat > /home/nexus/nexus/check_nesting.sh << 'NESTING'
    #!/usr/bin/env bash
    # Verify triple-nested isolation: Host → QEMU VM → Docker → inner KVM
    ERRORS=0

    # Must be inside a VM (detect QEMU/KVM hypervisor)
    if ! grep -qi 'qemu\|kvm\|virtual' /sys/class/dmi/id/product_name 2>/dev/null && \
       ! systemd-detect-virt -q 2>/dev/null; then
      echo "FATAL: NEXUS must run inside a QEMU/KVM virtual machine." >&2
      ERRORS=$((ERRORS + 1))
    fi

    # Docker must be available
    if ! docker version >/dev/null 2>&1; then
      echo "FATAL: Docker is not available. NEXUS requires Docker for container isolation." >&2
      ERRORS=$((ERRORS + 1))
    fi

    # KVM/libvirt must be available for inner VMs
    if ! virsh version >/dev/null 2>&1; then
      echo "FATAL: libvirt/KVM is not available. NEXUS requires inner VM capability." >&2
      ERRORS=$((ERRORS + 1))
    fi

    if [ "$ERRORS" -gt 0 ]; then
      echo "NEXUS requires triple-nested isolation (VM + Docker + inner KVM)." >&2
      echo "Install via: npx buildwithnexus init" >&2
      exit 1
    fi

    echo "Nesting check passed: VM + Docker + KVM verified."
    exit 0
    NESTING
  - chmod +x /home/nexus/nexus/check_nesting.sh
  - chown nexus:nexus /home/nexus/nexus/check_nesting.sh

  # Create systemd unit with nesting enforcement
  - |
    cat > /etc/systemd/system/nexus.service << 'UNIT'
    [Unit]
    Description=NEXUS Autonomous Runtime
    After=network.target docker.service libvirtd.service
    Requires=docker.service libvirtd.service

    [Service]
    Type=simple
    User=nexus
    WorkingDirectory=/home/nexus/nexus
    Environment=PATH=/home/nexus/nexus/.venv/bin:/usr/local/bin:/usr/bin:/bin
    ExecStartPre=/home/nexus/nexus/check_nesting.sh
    ExecStart=/home/nexus/nexus/.venv/bin/python -m src.main
    Restart=on-failure
    RestartSec=5
    StandardOutput=append:/home/nexus/.nexus/logs/server.log
    StandardError=append:/home/nexus/.nexus/logs/server.log
    LimitNOFILE=2048
    LimitNPROC=1024

    [Install]
    WantedBy=multi-user.target
    UNIT

  - sudo -u nexus mkdir -p /home/nexus/.nexus/logs
  - systemctl daemon-reload
  - systemctl enable nexus
  - systemctl start nexus

  # Signal completion
  - echo "NEXUS cloud-init complete" > /var/log/nexus-init.log

write_files:
  # API keys are NOT embedded in the ISO — they are uploaded via SSH after boot
  # See init.ts Phase 7 for the secure key delivery flow

  - path: /home/nexus/.nexus/config.yaml
    permissions: '0644'
    defer: true
    content: |
      nested_vm_enabled: true
      orchestration_mode: autonomous
      container_isolation: triple-nested
      ssh_auth: key-only
